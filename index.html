<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NORMAN | Chain of Command</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --charcoal: #2F3437; --sage: #87A96B; --red: #ff4d4d; --gold: #D4AF37; --white: #ffffff; --blue: #5ba4e1; }
        body { background: var(--charcoal); color: white; font-family: sans-serif; margin: 0; padding: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        
        #lobby { position: fixed; inset: 0; background: var(--charcoal); z-index: 200; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .lobby-card { background: #3f4447; padding: 30px; border-radius: 20px; width: 90%; max-width: 400px; text-align: center; border: 1px solid var(--sage); }
        .role-btn { background: rgba(255,255,255,0.05); border: 1px solid #555; color: white; padding: 15px; margin: 8px 0; border-radius: 12px; width: 100%; font-size: 16px; cursor: pointer; text-align: left; }
        
        #main-app { display: none; width: 100%; flex-direction: column; align-items: center; }
        #task-list { width: 90%; max-width: 400px; margin-top: 20px; padding-bottom: 150px; }
        .task-item { background: #3f4447; padding: 18px; border-radius: 15px; margin-bottom: 12px; border-left: 6px solid var(--sage); display: flex; justify-content: space-between; align-items: center; }
        .task-item.mine { border-left-color: var(--red); }
        .task-item.mgmt { border-left-color: var(--gold); }
        .task-item.kitchen { border-left-color: var(--blue); }

        #dispatcher { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 100; flex-direction: column; justify-content: center; align-items: center; }
        .mic-btn { position: fixed; bottom: 30px; background: var(--sage); border: none; border-radius: 50%; width: 80px; height: 80px; font-size: 35px; box-shadow: 0 0 25px rgba(0,0,0,0.5); z-index: 50; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="lobby">
    <div class="lobby-card">
        <h1 style="color:var(--sage); letter-spacing:4px;">ü¶â NORMAN</h1>
        <p style="font-size: 12px; opacity: 0.7; margin-bottom: 20px;">AUTHORISE POSITION</p>
        <button class="role-btn" onclick="checkAuth('mine')">üî¥ General Manager (PIN Required)</button>
        <button class="role-btn" onclick="checkAuth('mgmt')">üü° Management Team (PIN Required)</button>
        <button class="role-btn" onclick="selectRole('foh')">üü¢ Bar / Floor Team</button>
        <button class="role-btn" onclick="selectRole('kitchen')">üîµ Kitchen Team</button>
    </div>
</div>

<div id="main-app">
    <header style="text-align:center; padding: 20px;">
        <h2 id="view-title" style="margin:0; color:var(--sage); letter-spacing:2px; font-size: 16px;"></h2>
        <button style="background:none; border:none; color:#888; text-decoration:underline; font-size:10px;" onclick="location.reload()">Log Out</button>
    </header>
    <div id="task-list"></div>
    <button class="mic-btn" onclick="startVoice()">üéôÔ∏è</button>
</div>

<div id="dispatcher">
    <div style="background: #3f4447; padding: 25px; border-radius: 20px; width: 85%; text-align: center;">
        <p id="captured-text" style="color: var(--sage); margin-bottom: 20px; font-style: italic;"></p>
        
        <button id="dispatch-mine" class="role-btn" style="border-color: var(--red);" onclick="finalize('My List', 'mine')">üîí My List</button>
        <button id="dispatch-mgmt" class="role-btn" style="border-color: var(--gold);" onclick="finalize('Management', 'mgmt')">‚≠ê Management Team</button>
        <button id="dispatch-foh" class="role-btn" style="border-color: var(--sage);" onclick="finalize('Bar/Floor', 'foh')">üë• Bar/Floor Team</button>
        <button id="dispatch-kitchen" class="role-btn" style="border-color: var(--blue);" onclick="finalize('Kitchen', 'kitchen')">üç≥ Kitchen Team</button>
        
        <button style="background:none; color:white; border:none; margin-top:15px; opacity:0.5;" onclick="closeDisp()">Cancel</button>
    </div>
</div>

<script>
    const _s = supabase.createClient('https://wodvuhuekebtgeagcxff.supabase.co', 'sb_publishable_u5loOdmFIhABc535x5At8g_PVfrVeRH');
    let speechBuffer = "";
    let userRole = "";
    const MASTER_PIN = "1234"; // SET YOUR PIN HERE

    function checkAuth(role) {
        const pin = prompt("Enter Management PIN:");
        if (pin === MASTER_PIN) { selectRole(role); } 
        else { alert("Access Denied."); }
    }

    function selectRole(role) {
        userRole = role;
        document.getElementById('lobby').style.display = 'none';
        document.getElementById('main-app').style.display = 'flex';
        
        const titles = { mine: "GM COMMAND", mgmt: "MANAGEMENT TEAM", foh: "BAR / FLOOR", kitchen: "KITCHEN" };
        document.getElementById('view-title').innerText = titles[role];
        
        // HIDE DISPATCH BUTTONS FOR JUNIOR STAFF
        if (role === 'foh' || role === 'kitchen') {
            document.getElementById('dispatch-mine').classList.add('hidden');
            // Allow them to send to Mgmt, but not to your Private list
        }
        load();
    }

    async function load() {
        let query = _s.from('tasks').select('*').order('created_at', {ascending: false});
        if (userRole !== 'mine' && userRole !== 'mgmt') { 
            query = query.eq('department', userRole); 
        }
        const { data } = await query;
        if(data) {
            document.getElementById('task-list').innerHTML = data.map(t => `
                <div class="task-item ${t.department}">
                    <div><b>${t.task_name}</b><br><small>${t.assigned_to}</small></div>
                    <button onclick="finish('${t.id}')" style="background:none; border:1px solid #666; color:white; padding:8px; border-radius:8px;">DONE</button>
                </div>
            `).join('');
        }
    }

    function startVoice() {
        const rec = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        rec.onresult = (e) => {
            speechBuffer = e.results[0][0].transcript;
            document.getElementById('captured-text').innerText = `"${speechBuffer}"`;
            document.getElementById('dispatcher').style.display = 'flex';
        };
        rec.start();
    }

    async function finalize(label, type) {
        await _s.from('tasks').insert([{ task_name: speechBuffer, assigned_to: label, department: type }]);
        closeDisp();
        load();
    }

    function closeDisp() { document.getElementById('dispatcher').style.display = 'none'; }
    async function finish(id) { await _s.from('tasks').delete().eq('id', id); load(); }
    load();
</script>
</body>
</html>
